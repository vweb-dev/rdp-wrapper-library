{% extends "base.html" %}

{% block title %}Settings - RDP Wrapper Enhanced{% endblock %}

{% block content %}
<div x-data="settingsData()" x-init="init()">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900">Settings</h1>
        <p class="mt-2 text-gray-600">Configure your RDP Wrapper installation</p>
    </div>

    <!-- Settings Navigation -->
    <div class="bg-white rounded-lg shadow mb-8">
        <div class="border-b">
            <nav class="flex -mb-px">
                <button @click="activeTab = 'general'" 
                        :class="activeTab === 'general' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                        class="px-6 py-3 text-sm font-medium border-b-2">
                    General
                </button>
                <button @click="activeTab = 'security'" 
                        :class="activeTab === 'security' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                        class="px-6 py-3 text-sm font-medium border-b-2">
                    Security
                </button>
                <button @click="activeTab = 'network'" 
                        :class="activeTab === 'network' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                        class="px-6 py-3 text-sm font-medium border-b-2">
                    Network
                </button>
                <button @click="activeTab = 'advanced'" 
                        :class="activeTab === 'advanced' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                        class="px-6 py-3 text-sm font-medium border-b-2">
                    Advanced
                </button>
            </nav>
        </div>

        <!-- General Settings -->
        <div x-show="activeTab === 'general'" class="p-6">
            <form @submit.prevent="saveGeneralSettings()">
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Service Auto-Start</label>
                        <label class="inline-flex items-center">
                            <input type="checkbox" x-model="settings.general.autoStart" class="rounded border-gray-300">
                            <span class="ml-2 text-sm text-gray-600">Start RDP Wrapper service automatically on system boot</span>
                        </label>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Log Level</label>
                        <select x-model="settings.general.logLevel" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            <option value="debug">Debug</option>
                            <option value="info">Info</option>
                            <option value="warning">Warning</option>
                            <option value="error">Error</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Max Concurrent Sessions</label>
                        <input type="number" x-model="settings.general.maxSessions" min="1" max="100" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Session Timeout (minutes)</label>
                        <input type="number" x-model="settings.general.sessionTimeout" min="5" max="1440"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>

                    <div class="flex justify-end">
                        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition">
                            Save General Settings
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Security Settings -->
        <div x-show="activeTab === 'security'" class="p-6">
            <form @submit.prevent="saveSecuritySettings()">
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Enable Firewall</label>
                        <label class="inline-flex items-center">
                            <input type="checkbox" x-model="settings.security.firewall" class="rounded border-gray-300">
                            <span class="ml-2 text-sm text-gray-600">Enable Windows Firewall protection for RDP</span>
                        </label>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">IP Whitelist</label>
                        <textarea x-model="settings.security.ipWhitelist" rows="4" 
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md"
                                  placeholder="Enter allowed IP addresses (one per line)"></textarea>
                        <p class="text-xs text-gray-500 mt-1">Leave empty to allow all IPs</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Failed Login Attempts</label>
                        <input type="number" x-model="settings.security.maxAttempts" min="1" max="10"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        <p class="text-xs text-gray-500 mt-1">Lock account after this many failed attempts</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Lockout Duration (minutes)</label>
                        <input type="number" x-model="settings.security.lockoutDuration" min="1" max="60"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>

                    <div class="flex justify-end">
                        <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition">
                            Save Security Settings
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Network Settings -->
        <div x-show="activeTab === 'network'" class="p-6">
            <form @submit.prevent="saveNetworkSettings()">
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Port Number</label>
                        <input type="number" x-model="settings.network.port" min="1024" max="65535"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        <p class="text-xs text-gray-500 mt-1">Default: 3389</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Network Adapter</label>
                        <select x-model="settings.network.adapter" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            <option value="all">All Adapters</option>
                            <option value="ethernet">Ethernet Only</option>
                            <option value="wifi">WiFi Only</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Bandwidth Limit (kbps)</label>
                        <input type="number" x-model="settings.network.bandwidthLimit" min="0" max="100000"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        <p class="text-xs text-gray-500 mt-1">0 = unlimited</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Enable Compression</label>
                        <label class="inline-flex items-center">
                            <input type="checkbox" x-model="settings.network.compression" class="rounded border-gray-300">
                            <span class="ml-2 text-sm text-gray-600">Enable RDP compression for better performance</span>
                        </label>
                    </div>

                    <div class="flex justify-end">
                        <button type="submit" class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 transition">
                            Save Network Settings
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Advanced Settings -->
        <div x-show="activeTab === 'advanced'" class="p-6">
            <form @submit.prevent="saveAdvancedSettings()">
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Enable Debug Mode</label>
                        <label class="inline-flex items-center">
                            <input type="checkbox" x-model="settings.advanced.debugMode" class="rounded border-gray-300">
                            <span class="ml-2 text-sm text-gray-600">Enable detailed logging for troubleshooting</span>
                        </label>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Custom Registry Keys</label>
                        <textarea x-model="settings.advanced.registryKeys" rows="6"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md"
                                  placeholder="Enter custom registry modifications (JSON format)"></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Backup Configuration</label>
                        <button type="button" @click="backupConfig()" 
                                class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 transition">
                            Create Backup
                        </button>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Restore Configuration</label>
                        <input type="file" @change="restoreConfig($event)" accept=".json"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>

                    <div class="flex justify-end">
                        <button type="submit" class="bg-orange-600 text-white px-4 py-2 rounded-md hover:bg-orange-700 transition">
                            Save Advanced Settings
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function settingsData() {
    return {
        activeTab: 'general',
        settings: {
            general: {
                autoStart: true,
                logLevel: 'info',
                maxSessions: 10,
                sessionTimeout: 60
            },
            security: {
                firewall: true,
                ipWhitelist: '',
                maxAttempts: 5,
                lockoutDuration: 15
            },
            network: {
                port: 3389,
                adapter: 'all',
                bandwidthLimit: 0,
                compression: true
            },
            advanced: {
                debugMode: false,
                registryKeys: ''
            }
        },
        
        async init() {
            await this.loadSettings();
        },
        
        async loadSettings() {
            try {
                const data = await apiRequest('/api/settings');
                this.settings = { ...this.settings, ...data };
            } catch (error) {
                console.error('Failed to load settings:', error);
            }
        },
        
        async saveGeneralSettings() {
            await this.saveSettings('general', this.settings.general);
        },
        
        async saveSecuritySettings() {
            await this.saveSettings('security', this.settings.security);
        },
        
        async saveNetworkSettings() {
            await this.saveSettings('network', this.settings.network);
        },
        
        async saveAdvancedSettings() {
            await this.saveSettings('advanced', this.settings.advanced);
        },
        
        async saveSettings(type, settings) {
            try {
                await apiRequest(`/api/settings/${type}`, {
                    method: 'POST',
                    body: JSON.stringify(settings)
                });
                showNotification(`${type.charAt(0).toUpperCase() + type.slice(1)} settings saved successfully`, 'success');
            } catch (error) {
                showNotification(`Failed to save ${type} settings`, 'error');
            }
        },
        
        async backupConfig() {
            try {
                const response = await apiRequest('/api/settings/backup', { method: 'POST' });
                const blob = new Blob([JSON.stringify(response, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `rdp-wrapper-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                showNotification('Configuration backup created successfully', 'success');
            } catch (error) {
                showNotification('Failed to create backup', 'error');
            }
        },
        
        async restoreConfig(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            try {
                const text = await file.text();
                const config = JSON.parse(text);
                
                await apiRequest('/api/settings/restore', {
                    method: 'POST',
                    body: JSON.stringify(config)
                });
                
                showNotification('Configuration restored successfully', 'success');
                await this.loadSettings();
            } catch (error) {
                showNotification('Failed to restore configuration', 'error');
            }
        }
    }
}
</script>
{% endblock %}
